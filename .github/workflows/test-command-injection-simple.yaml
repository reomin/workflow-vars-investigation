name: Simple Command Injection Test

on:
  workflow_dispatch:
    inputs:
      malicious_input:
        description: 'Test input (try: test"; whoami #)'
        required: true
        default: 'safe-input'

permissions:
  contents: read

jobs:
  # ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç›´æŽ¥ ${{ }} ã‚’ä½¿ã†ï¼ˆæœ€ã‚‚å±é™ºï¼‰
  pattern-1-direct:
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ”´ Pattern 1: Direct \${{ }} in run (MOST DANGEROUS)"
        run: |
          echo "=========================================="
          echo "Pattern 1: Direct interpolation"
          echo "Input value: ${{ inputs.malicious_input }}"
          echo "=========================================="
          result="$(echo 'Processing: ${{ inputs.malicious_input }}')"
          echo "Result: ${result}"
          echo ""

  # ãƒ‘ã‚¿ãƒ¼ãƒ³2: envçµŒç”± + ã‚³ãƒžãƒ³ãƒ‰ç½®æ›ï¼ˆã¾ã å±é™ºï¼‰
  pattern-2-env-with-substitution:
    runs-on: ubuntu-latest
    env:
      MALICIOUS_INPUT: ${{ inputs.malicious_input }}
    steps:
      - name: "ðŸ”´ Pattern 2: env + command substitution (STILL DANGEROUS)"
        run: |
          echo "=========================================="
          echo "Pattern 2: env with \$(...)"
          echo "Input from env: ${MALICIOUS_INPUT}"
          echo "=========================================="
          result="$(echo "Processing: ${MALICIOUS_INPUT}")"
          echo "Result: ${result}"
          echo ""

  # ãƒ‘ã‚¿ãƒ¼ãƒ³3: envçµŒç”±ã®ã¿ï¼ˆå®‰å…¨ï¼‰
  pattern-3-env-safe:
    runs-on: ubuntu-latest
    env:
      MALICIOUS_INPUT: ${{ inputs.malicious_input }}
    steps:
      - name: "âœ… Pattern 3: env without command substitution (SAFE)"
        run: |
          echo "=========================================="
          echo "Pattern 3: env without \$(...)"
          echo "Input from env: ${MALICIOUS_INPUT}"
          echo "=========================================="
          # ã‚³ãƒžãƒ³ãƒ‰ç½®æ›ã‚’ä½¿ã‚ãšã«ç›´æŽ¥ä½¿ç”¨
          echo "Direct use: ${MALICIOUS_INPUT}"
          echo ""

  # ãƒ‘ã‚¿ãƒ¼ãƒ³4: env + ifæ–‡ï¼ˆæœ€ã‚‚å®‰å…¨ï¼‰
  pattern-4-env-with-if:
    runs-on: ubuntu-latest
    env:
      MALICIOUS_INPUT: ${{ inputs.malicious_input }}
    steps:
      - name: "âœ… Pattern 4: env with if statement (SAFEST)"
        run: |
          echo "=========================================="
          echo "Pattern 4: env with if"
          echo "Input from env: ${MALICIOUS_INPUT}"
          echo "=========================================="
          if echo "${MALICIOUS_INPUT}" | grep -q .; then
            echo "Input is not empty"
          else
            echo "Input is empty"
          fi
          echo ""

  # æ¯”è¼ƒãƒ†ã‚¹ãƒˆ
  comparison-test:
    runs-on: ubuntu-latest
    needs: [pattern-1-direct, pattern-2-env-with-substitution, pattern-3-env-safe, pattern-4-env-with-if]
    if: always()
    env:
      TEST_INPUT: ${{ inputs.malicious_input }}
    steps:
      - name: "Create comparison report"
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # Command Injection Test Comparison

          ## Test Input
          ```
          ${{ inputs.malicious_input }}
          ```

          ## Results Summary

          | Pattern | Method | Safety | Notes |
          |---------|--------|--------|-------|
          | 1 | `${{ }}` in run | ðŸ”´ DANGEROUS | Shell interprets immediately |
          | 2 | `env` + `$(...)` | ðŸ”´ DANGEROUS | Command substitution re-interprets |
          | 3 | `env` only | âœ… SAFE | No re-interpretation |
          | 4 | `env` + `if` | âœ… SAFE | Direct conditional |

          ## Try These Test Inputs

          ### Safe Input
          ```
          safe-input
          ```

          ### Injection Attempts (for testing)
          ```
          test"; echo INJECTED #
          test$(whoami)test
          test && echo INJECTED
          ```

          ## Key Takeaway

          **Using `env:` is necessary but not sufficient!**

          - âŒ `result=$(command "${ENV_VAR}")` â† Still vulnerable
          - âœ… `if command "${ENV_VAR}"; then` â† Safe
          - âœ… `echo "${ENV_VAR}"` â† Safe

          The difference is whether the shell **re-interprets** the variable value.
          EOF

      - name: "Detailed explanation"
        run: |
          echo "=========================================="
          echo "Why is Pattern 2 still dangerous?"
          echo "=========================================="
          echo ""
          echo "Even with env, this happens:"
          echo "1. GitHub sets: MALICIOUS_INPUT='test\"; echo INJECTED #'"
          echo "2. Shell sees: result=\"\$(echo \"Processing: \${MALICIOUS_INPUT}\")\""
          echo "3. Shell expands: result=\"\$(echo \"Processing: test\"; echo INJECTED #\")\""
          echo "4. Shell executes inside \$():"
          echo "   - echo \"Processing: test\""
          echo "   - echo INJECTED"
          echo "   - # (comment)"
          echo ""
          echo "The \$(...) causes the shell to re-interpret!"
          echo ""
